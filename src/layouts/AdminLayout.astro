---
import "../styles/global.css";

interface Props {
	title: string;
	description?: string;
}

const { title, description = "Admin Dashboard - Project Likha" } = Astro.props;

// Get user info - defensive approach
const locals = Astro.locals as any;
const user = locals?.user;

// Check if user has admin or moderator role
const hasAdminAccess = user?.role === "ADMIN" || user?.role === "MODERATOR";

if (!hasAdminAccess) {
	return Astro.redirect("/login");
}

import AdminSidebar from "../components/AdminSidebar.astro";
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/Char.svg" />
		<meta name="generator" content={Astro.generator} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@600&family=Schibsted+Grotesk:wght@700&display=swap"
			rel="stylesheet"
		/>
		<title>{title}</title>
	</head>
	<body class="bg-neutral-900 text-white min-h-screen">
		<div class="flex h-screen">
			<!-- Admin Sidebar -->
			<AdminSidebar user={user} />

			<!-- Main Content -->
			<div class="flex-1 flex flex-col overflow-hidden bg-neutral-950/50 border-l border-neutral-800/50">
				<!-- Top Bar -->
				<header
					class="bg-neutral-900/50 backdrop-blur-xl border-b border-neutral-800/50 px-8 py-5 flex items-center justify-between z-40 relative"
				>
					<div class="flex items-center gap-6">
						<button
							id="sidebar-toggle"
							class="lg:hidden p-2 rounded-xl bg-neutral-800 text-gray-400 hover:text-white transition-all"
						>
							<svg
								class="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
						<div>
							<h1
								class="text-3xl font-normal text-white tracking-tight"
								style="font-family: 'Bebas Neue', sans-serif;"
							>
								{title}
							</h1>
							<div class="flex items-center gap-2 mt-1">
								<span
									class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
								></span>
								<p
									class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest"
									style="font-family: 'Schibsted Grotesk', sans-serif;"
								>
									System Live
								</p>
							</div>
						</div>
					</div>

					<!-- User Menu -->
					<div class="flex items-center gap-6">
						<!-- Notifications or other icons can go here -->
						<div
							class="hidden md:flex items-center gap-2 px-4 py-2 rounded-xl bg-neutral-800/50 border border-neutral-700/30"
						>
							<div class="w-2 h-2 rounded-full bg-blue-500"></div>
							<span
								class="text-[10px] font-bold text-neutral-400 uppercase tracking-wider"
								style="font-family: 'Schibsted Grotesk', sans-serif;"
								>Internal Network</span
							>
						</div>

						<div class="relative" id="admin-user-menu-container">
							<button
								type="button"
								id="admin-user-menu-btn"
								class="flex items-center gap-3 p-1.5 pr-4 rounded-2xl hover:bg-white/5 transition-all duration-300 border border-transparent hover:border-neutral-700/50 group"
							>
								{
									user?.avatar ? (
										<img
											src={user.avatar}
											alt={
												user.username ||
												user.name ||
												"User"
											}
											class="w-10 h-10 rounded-xl object-cover shadow-lg"
										/>
									) : (
										<div
											class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-blue-400 flex items-center justify-center text-white font-bold text-lg shadow-lg"
											style="font-family: 'Bebas Neue', sans-serif;"
										>
											{(
												user?.username ||
												user?.name ||
												"U"
											)
												.charAt(0)
												.toUpperCase()}
										</div>
									)
								}
								<div class="hidden sm:block text-left">
									<p
										class="text-sm font-bold text-white leading-none group-hover:text-blue-400 transition-colors"
										style="font-family: 'Schibsted Grotesk', sans-serif;"
									>
										{user?.username || user?.name}
									</p>
									<p
										class="text-[10px] text-neutral-500 font-bold uppercase tracking-wider mt-1"
									>
										{user?.role}
									</p>
								</div>
								<svg
									class="w-4 h-4 text-neutral-600 group-hover:text-neutral-400 transition-colors ml-2"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M19 9l-7 7-7-7"></path>
								</svg>
							</button>

							<!-- Dropdown Menu -->
							<div
								id="admin-user-dropdown"
								class="absolute right-0 top-full mt-4 w-64 bg-neutral-900 rounded-2xl border border-neutral-800 shadow-2xl p-2 hidden animate-in fade-in slide-in-from-top-2 duration-200 z-50"
							>
								<div
									class="px-4 py-4 mb-2 border-b border-neutral-800/50"
								>
									<p
										class="text-sm font-bold text-white truncate"
										style="font-family: 'Schibsted Grotesk', sans-serif;"
									>
										{user?.username || user?.name}
									</p>
									<p
										class="text-xs text-neutral-500 truncate mt-1"
									>
										{user?.email}
									</p>
								</div>
								<div class="space-y-1">
									<a
										href="/profile"
										class="flex items-center gap-3 px-4 py-2.5 text-sm text-neutral-400 hover:bg-white/5 hover:text-white rounded-xl transition-all"
									>
										<svg
											class="w-4 h-4"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
											></path>
										</svg>
										Public Profile
									</a>
									<a
										href="/"
										class="flex items-center gap-3 px-4 py-2.5 text-sm text-neutral-400 hover:bg-white/5 hover:text-white rounded-xl transition-all"
									>
										<svg
											class="w-4 h-4"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
											></path>
										</svg>
										Back to Site
									</a>
								</div>
								<div
									class="mt-2 pt-2 border-t border-neutral-800/50"
								>
									<button
										type="button"
										id="admin-logout-btn"
										class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-400/10 rounded-xl transition-all font-medium"
									>
										<svg
											class="w-4 h-4"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
											></path>
										</svg>
										Sign out
									</button>
								</div>
							</div>
						</div>
					</div>
				</header>

				<!-- Page Content -->
				<main class="flex-1 overflow-auto p-10 custom-scrollbar">
					<slot />
				</main>
				
				<!-- Admin Footer -->
				<footer class="bg-neutral-900/50 backdrop-blur-xl border-t border-neutral-800/50 px-8 py-4">
					<div class="flex items-center justify-between">
						<p class="text-xs text-neutral-500">
							Admin Dashboard Â© {new Date().getFullYear()} Project Likha
						</p>
						<div class="flex items-center gap-2 text-xs text-neutral-600">
							<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
							<span>System Operational</span>
						</div>
					</div>
				</footer>
			</div>
		</div>
	</body>
</html>

<script>
	import { authClient } from "../lib/auth-client";

	document.addEventListener("DOMContentLoaded", () => {
		const menuBtn = document.getElementById("admin-user-menu-btn");
		const dropdown = document.getElementById("admin-user-dropdown");
		const logoutBtn = document.getElementById("admin-logout-btn");
		const sidebarToggle = document.getElementById("sidebar-toggle");
		const sidebar = document.getElementById("admin-sidebar");

		if (menuBtn && dropdown) {
			// Toggle dropdown
			menuBtn.addEventListener("click", (e) => {
				e.stopPropagation();
				dropdown.classList.toggle("hidden");
			});

			// Close dropdown when clicking outside
			document.addEventListener("click", (e) => {
				if (
					!dropdown.contains(e.target as Node) &&
					!menuBtn.contains(e.target as Node)
				) {
					dropdown.classList.add("hidden");
				}
			});

			// Close dropdown on escape key
			document.addEventListener("keydown", (e) => {
				if (e.key === "Escape") {
					dropdown.classList.add("hidden");
				}
			});
		}

		// Logout handler
		if (logoutBtn) {
			logoutBtn.addEventListener("click", async () => {
				try {
					await authClient.signOut();
					window.location.href = "/";
				} catch (error) {
					console.error("Logout failed:", error);
					window.location.href = "/";
				}
			});
		}

		// Mobile sidebar toggle
		if (sidebarToggle && sidebar) {
			sidebarToggle.addEventListener("click", () => {
				sidebar.classList.toggle("hidden");
			});
		}
	});
</script>

<style>
	/* Admin-specific styles */
	.admin-sidebar {
		transition: transform 0.3s ease;
	}

	@media (max-width: 1024px) {
		.admin-sidebar {
			position: fixed;
			z-index: 40;
			height: 100vh;
		}

		.admin-sidebar.hidden {
			transform: translateX(-100%);
		}
	}

	.custom-scrollbar::-webkit-scrollbar {
		width: 6px;
	}
	.custom-scrollbar::-webkit-scrollbar-track {
		background: transparent;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb {
		background: #262626;
		border-radius: 10px;
	}
	.custom-scrollbar::-webkit-scrollbar-thumb:hover {
		background: #404040;
	}

	/* Ensure proper border alignment */
	.admin-sidebar {
		border-right: 1px solid rgba(64, 64, 64, 0.5);
	}
	
	.admin-sidebar + div {
		border-left: 1px solid rgba(64, 64, 64, 0.5);
	}
	
	/* Fix header border alignment */
	header {
		position: relative;
	}
	
	header::before {
		content: '';
		position: absolute;
		left: 0;
		bottom: -1px;
		right: 0;
		height: 1px;
		background: rgba(64, 64, 64, 0.5);
		z-index: 1;
	}
</style>
