---
import "../styles/global.css";

interface Props {
	title: string;
	description?: string;
}

const { title, description = "Admin Dashboard - Project Likha" } = Astro.props;

// Get user info - defensive approach
const user = Astro.locals.user;

// Check if user has admin or moderator role
const hasAdminAccess = user?.role === "ADMIN" || user?.role === "MODERATOR";

if (!hasAdminAccess) {
	return Astro.redirect("/login");
}

import AdminSidebar from "../components/AdminSidebar.astro";
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/Char.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
	</head>
	<body class="bg-gray-50 text-gray-900 min-h-screen">
		<div class="flex h-screen">
			<!-- Admin Sidebar -->
			<AdminSidebar user={user} />

			<!-- Main Content -->
			<div class="flex-1 flex flex-col overflow-hidden">
				<!-- Top Bar -->
				<header
					class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between"
				>
					<div class="flex items-center gap-4">
						<button
							id="sidebar-toggle"
							class="lg:hidden p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors"
						>
							<svg
								class="w-5 h-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M4 6h16M4 12h16M4 18h16"
								></path>
								</svg>
							</button>
						<div>
							<h1 class="text-xl font-semibold text-gray-900">
								{title}
							</h1>
						</div>
					</div>

					<!-- User Menu -->
					<div class="flex items-center gap-4">
						<div class="relative" id="admin-user-menu-container">
							<button
								type="button"
								id="admin-user-menu-btn"
								class="flex items-center gap-3 p-1.5 pr-3 rounded-lg hover:bg-gray-100 transition-colors border border-transparent hover:border-gray-200"
							>
								{
									user?.avatar ? (
										<img
											src={user.avatar}
											alt={
												user.username ||
												user.name ||
												"User"
											}
											class="w-8 h-8 rounded-lg object-cover"
										/>
									) : (
										<div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-semibold text-sm">
											{(
												user?.username ||
												user?.name ||
												"U"
											)
												.charAt(0)
												.toUpperCase()}
										</div>
									)
								}
								<div class="hidden sm:block text-left">
									<p class="text-sm font-medium text-gray-900">
										{user?.username || user?.name}
									</p>
									<p class="text-xs text-gray-500">
										{user?.role}
									</p>
								</div>
								<svg
									class="w-4 h-4 text-gray-400"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M19 9l-7 7-7-7"
									></path>
									</svg>
								</button>

							<!-- Dropdown Menu -->
							<div
								id="admin-user-dropdown"
								class="absolute right-0 top-full mt-2 w-56 bg-white rounded-lg border border-gray-200 shadow-lg p-1 hidden z-50"
							>
								<div class="px-3 py-2 mb-1 border-b border-gray-100">
									<p class="text-sm font-medium text-gray-900 truncate">
										{user?.username || user?.name}
									</p>
									<p class="text-xs text-gray-500 truncate">
										{user?.email}
									</p>
								</div>
								<div class="space-y-0.5">
									<a
										href="/profile"
										class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
									>
										<svg
											class="w-4 h-4"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
											></path>
											</svg>
											Public Profile
										</a>
										<a
											href="/"
											class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
										>
											<svg
												class="w-4 h-4"
												fill="none"
												stroke="currentColor"
												viewBox="0 0 24 24"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
												></path>
											</svg>
												Back to Site
											</a>
										</div>
										<div class="mt-1 pt-1 border-t border-gray-100">
											<button
												type="button"
												id="admin-logout-btn"
												class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
											>
												<svg
													class="w-4 h-4"
													fill="none"
													stroke="currentColor"
													viewBox="0 0 24 24"
												>
													<path
														stroke-linecap="round"
														stroke-linejoin="round"
														stroke-width="2"
														d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
													></path>
												</svg>
												Sign out
											</button>
										</div>
									</div>
								</div>
							</div>
						</header>

						<!-- Page Content -->
						<main class="flex-1 overflow-auto p-6 bg-gray-50">
							<slot />
						</main>
					</div>
				</div>
			</body>
		</html>

		<script>
			import { authClient } from "../lib/auth-client";

			document.addEventListener("DOMContentLoaded", () => {
				const menuBtn = document.getElementById("admin-user-menu-btn");
				const dropdown = document.getElementById("admin-user-dropdown");
				const logoutBtn = document.getElementById("admin-logout-btn");
				const sidebarToggle = document.getElementById("sidebar-toggle");
				const sidebar = document.getElementById("admin-sidebar");

				if (menuBtn && dropdown) {
					// Toggle dropdown
					menuBtn.addEventListener("click", (e) => {
						e.stopPropagation();
						dropdown.classList.toggle("hidden");
					});

					// Close dropdown when clicking outside
					document.addEventListener("click", (e) => {
						if (
							!dropdown.contains(e.target as Node) &&
							!menuBtn.contains(e.target as Node)
						) {
							dropdown.classList.add("hidden");
						}
					});

					// Close dropdown on escape key
					document.addEventListener("keydown", (e) => {
						if (e.key === "Escape") {
							dropdown.classList.add("hidden");
						}
					});
				}

				// Handle logout
				if (logoutBtn) {
					logoutBtn.addEventListener("click", async () => {
						try {
							await authClient.signOut();
							window.location.href = "/login";
						} catch (error) {
							console.error("Logout failed:", error);
							window.location.href = "/login";
						}
					});
				}

				// Mobile sidebar toggle
				if (sidebarToggle && sidebar) {
					sidebarToggle.addEventListener("click", () => {
						sidebar.classList.toggle("-translate-x-full");
					});
				}
			});
		</script>

		<style>
			.custom-scrollbar::-webkit-scrollbar {
				width: 6px;
			}
			.custom-scrollbar::-webkit-scrollbar-track {
				background: transparent;
			}
			.custom-scrollbar::-webkit-scrollbar-thumb {
				background: #d1d5db;
				border-radius: 3px;
			}
			.custom-scrollbar::-webkit-scrollbar-thumb:hover {
				background: #9ca3af;
			}
		</style>
