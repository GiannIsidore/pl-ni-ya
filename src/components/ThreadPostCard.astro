---
import prisma from '../lib/prisma';

interface Props {
  thread: {
    id: number;
    title: string;
    content: string;
    createdAt: Date;
    views: number;
    author: {
      id: string;
      username: string;
      avatar?: string | null;
    };
  };
  threadId: number;
}

const { thread, threadId } = Astro.props;
const { user } = Astro.locals;

function formatDate(date: Date): string {
  const d = new Date(date);
  const now = new Date();
  const diffMs = now.getTime() - d.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return d.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}

// Fetch real like data
const likes = await prisma.like.findMany({
  where: { threadId },
  include: {
    user: {
      select: {
        id: true,
        username: true,
        avatar: true,
      },
    },
  },
  orderBy: { createdAt: 'desc' },
});

const likeCount = likes.length;
const likedByUsers = likes.slice(0, 3).map(like => like.user.username);
const otherLikes = likeCount > 3 ? likeCount - 3 : 0;

// Format "liked by" text
let likedByText = '';
if (likeCount === 1) {
  likedByText = likedByUsers[0];
} else if (likeCount === 2) {
  likedByText = `${likedByUsers[0]} and ${likedByUsers[1]}`;
} else if (likeCount >= 3) {
  likedByText = likedByUsers.join(', ');
}
---

<div class="thread-post-card bg-neutral-800 rounded-lg border border-neutral-700 p-6 mb-6" data-thread-id={threadId}>
  <div class="flex gap-4">
    <!-- Avatar -->
    <div class="flex-shrink-0">
      {thread.author.avatar ? (
        <img 
          src={thread.author.avatar} 
          alt={thread.author.username}
          class="w-12 h-12 rounded-full object-cover"
        />
      ) : (
        <div class="w-12 h-12 rounded-full bg-neutral-700 flex items-center justify-center overflow-hidden">
          <svg class="w-8 h-8 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
          </svg>
        </div>
      )}
    </div>

    <!-- Content -->
    <div class="flex-1 min-w-0">
      <!-- Author & Date -->
      <div class="flex items-center gap-3 mb-3">
        <span class="text-white font-semibold text-base">
          {thread.author.username}
        </span>
        <span class="px-2 py-0.5 text-xs bg-blue-900 text-blue-200 rounded">
          Contributor
        </span>
        <span class="text-gray-400 text-sm">
          {formatDate(thread.createdAt)}
        </span>
      </div>

      <!-- Thread Content -->
      <div 
        class="thread-post-content text-gray-300 text-base leading-relaxed mb-4 prose prose-invert max-w-none"
        set:html={thread.content}
      />

      <!-- Interaction Buttons -->
      <div class="flex items-center gap-4 mb-3">
        <button 
          type="button"
          class="like-btn flex items-center gap-2 text-sm text-gray-400 hover:text-blue-400 transition-colors"
          data-thread-id={threadId}
          data-liked="false"
        >
          <svg class="like-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
          </svg>
          <span class="like-count">{likeCount}</span>
        </button>
        
        <button 
          type="button"
          class="reply-btn flex items-center gap-2 text-sm text-gray-400 hover:text-blue-400 transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
          </svg>
          Reply
        </button>
      </div>

      <!-- Who Liked -->
      <div class="liked-by-container text-xs text-gray-400 mb-2" style={likeCount === 0 ? 'display: none;' : ''}>
        <span class="liked-by-text">{likedByText}</span>
        {otherLikes > 0 && (
          <span class="others-text"> and {otherLikes} other{otherLikes > 1 ? 's' : ''}</span>
        )}
        <span> liked this</span>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const threadCards = document.querySelectorAll('.thread-post-card');
    
    threadCards.forEach((card) => {
      const likeBtn = card.querySelector('.like-btn') as HTMLButtonElement;
      if (!likeBtn) return;
      
      const threadId = likeBtn.getAttribute('data-thread-id');
      if (!threadId) return;
      
      likeBtn.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/likes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ threadId: parseInt(threadId) }),
          });
          
          if (!response.ok) {
            if (response.status === 401) {
              // Show login modal or redirect
              if (confirm('You need to be logged in to like posts. Would you like to log in?')) {
                window.location.href = `/login?returnUrl=${encodeURIComponent(window.location.pathname)}`;
              }
              return;
            }
            throw new Error('Failed to toggle like');
          }
          
          const result = await response.json();
          const likeCountEl = likeBtn.querySelector('.like-count');
          const likeIcon = likeBtn.querySelector('.like-icon');
          const likedByContainer = card.querySelector('.liked-by-container') as HTMLElement;
          
          if (likeCountEl) {
            const currentCount = parseInt(likeCountEl.textContent || '0');
            const newCount = result.action === 'liked' ? currentCount + 1 : currentCount - 1;
            likeCountEl.textContent = newCount.toString();
            
            // Show/hide liked by container
            if (likedByContainer) {
              likedByContainer.style.display = newCount > 0 ? '' : 'none';
            }
          }
          
          // Toggle active state
          if (result.action === 'liked') {
            likeBtn.classList.add('text-blue-400');
            likeBtn.classList.remove('text-gray-400');
            likeBtn.setAttribute('data-liked', 'true');
            if (likeIcon) {
              likeIcon.setAttribute('fill', 'currentColor');
            }
          } else {
            likeBtn.classList.remove('text-blue-400');
            likeBtn.classList.add('text-gray-400');
            likeBtn.setAttribute('data-liked', 'false');
            if (likeIcon) {
              likeIcon.setAttribute('fill', 'none');
            }
          }
        } catch (error) {
          console.error('Like error:', error);
        }
      });
    });
  });
</script>

<style>
  @reference "../styles/global.css";
  
  .thread-post-content :global(p) {
    @apply mb-3;
  }

  .thread-post-content :global(ul),
  .thread-post-content :global(ol) {
    @apply ml-6 mb-3;
  }

  .thread-post-content :global(ul) {
    @apply list-disc;
  }

  .thread-post-content :global(ol) {
    @apply list-decimal;
  }

  .thread-post-content :global(blockquote) {
    @apply border-l-4 border-blue-400 pl-4 italic text-gray-300 my-3 bg-blue-900/20 py-2 rounded-r;
  }

  .thread-post-content :global(a) {
    @apply text-blue-400 underline hover:text-blue-300;
  }

  .thread-post-content :global(img) {
    @apply max-w-full h-auto rounded my-3;
  }

  .thread-post-content :global(code) {
    @apply bg-neutral-700 px-1.5 py-0.5 rounded text-amber-400 text-sm;
  }

  .thread-post-content :global(pre) {
    @apply bg-neutral-900 border border-neutral-700 p-4 rounded my-3 overflow-x-auto;
  }

  .thread-post-content :global(pre code) {
    @apply bg-transparent p-0 text-gray-200;
  }

  /* Syntax highlighting - Lowlight/Highlight.js classes */
  .thread-post-content :global(.hljs-keyword),
  .thread-post-content :global(.hljs-selector-tag),
  .thread-post-content :global(.hljs-built_in),
  .thread-post-content :global(.hljs-name) {
    @apply text-purple-600 dark:text-purple-400;
  }

  .thread-post-content :global(.hljs-string),
  .thread-post-content :global(.hljs-attr),
  .thread-post-content :global(.hljs-symbol),
  .thread-post-content :global(.hljs-bullet) {
    @apply text-green-600 dark:text-green-400;
  }

  .thread-post-content :global(.hljs-number),
  .thread-post-content :global(.hljs-literal) {
    @apply text-orange-600 dark:text-orange-400;
  }

  .thread-post-content :global(.hljs-title),
  .thread-post-content :global(.hljs-section),
  .thread-post-content :global(.hljs-selector-class) {
    @apply text-yellow-600 dark:text-yellow-400;
  }

  .thread-post-content :global(.hljs-function),
  .thread-post-content :global(.hljs-title.function_) {
    @apply text-blue-600 dark:text-blue-400;
  }

  .thread-post-content :global(.hljs-comment),
  .thread-post-content :global(.hljs-quote) {
    @apply text-gray-500 italic;
  }

  .thread-post-content :global(.hljs-meta),
  .thread-post-content :global(.hljs-tag) {
    @apply text-cyan-600 dark:text-cyan-400;
  }

  .thread-post-content :global(.hljs-attribute),
  .thread-post-content :global(.hljs-selector-attr) {
    @apply text-cyan-500 dark:text-cyan-300;
  }

  .thread-post-content :global(.hljs-variable),
  .thread-post-content :global(.hljs-template-variable),
  .thread-post-content :global(.hljs-params) {
    @apply text-red-600 dark:text-red-400;
  }

  .thread-post-content :global(.hljs-regexp) {
    @apply text-red-500 dark:text-red-300;
  }

  .thread-post-content :global(.hljs-type),
  .thread-post-content :global(.hljs-class .hljs-title) {
    @apply text-teal-600 dark:text-teal-400;
  }
  
  .like-btn[data-liked="true"] .like-icon {
    fill: currentColor;
  }
</style>
