---
import { Image } from "astro:assets";
import logo from "../assets/logo2.svg";

const { user } = Astro.locals;
---

<nav class="w-[100%] bg-neutral-900 pb-1 text-white px-6 lg:px-12 py-4 flex items-center justify-between sticky top-0 z-50">
  <div>
    <a href="/">
      <Image
        src={logo}
        alt="Project Likha Logo"
        width={100}
        height={100}
        class="w-40 h-30"
      />
    </a>
  </div>
  
  <div class="flex items-center gap-8">
    <!-- Navigation Links -->
    <div class="hidden md:flex items-center gap-8">
      <a href="/blogs" class="hover:text-gray-300 transition-colors nav-link">Blogs</a>
      <a href="/forums" class="hover:text-gray-300 transition-colors nav-link">Forums</a>
      <a href="#" class="hover:text-gray-300 transition-colors nav-link">About us</a>
      <a href="#" class="hover:text-gray-300 transition-colors nav-link">Ideas</a>
      <a href="#" class="hover:text-gray-300 transition-colors nav-link">Projects</a>
    </div>

    <!-- Auth Section -->
    {user ? (
      <!-- Logged In: User Menu -->
      <div class="relative" id="user-menu-container">
        <button 
          type="button" 
          id="user-menu-btn"
          class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-neutral-800 transition-colors"
        >
          {user.avatar ? (
            <img 
              src={user.avatar} 
              alt={user.username || user.name || 'User'} 
              class="w-8 h-8 rounded-full object-cover"
            />
          ) : (
            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold text-sm">
              {(user.username || user.name || 'U').charAt(0).toUpperCase()}
            </div>
          )}
          <span class="hidden sm:block text-sm font-medium">{user.username || user.name}</span>
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        
        <!-- Dropdown Menu -->
        <div 
          id="user-dropdown" 
          class="absolute right-0 top-full mt-2 w-48 bg-neutral-800 rounded-lg border border-neutral-700 shadow-xl hidden"
        >
          <div class="px-4 py-3 border-b border-neutral-700">
            <p class="text-sm font-medium text-white truncate">{user.username || user.name}</p>
            <p class="text-xs text-gray-400 truncate">{user.email}</p>
          </div>
          <div class="py-1">
            <a href="/profile" class="block px-4 py-2 text-sm text-gray-300 hover:bg-neutral-700 transition-colors">
              Profile
            </a>
            <a href="/settings" class="block px-4 py-2 text-sm text-gray-300 hover:bg-neutral-700 transition-colors">
              Settings
            </a>
          </div>
          <div class="py-1 border-t border-neutral-700">
            <button 
              type="button" 
              id="logout-btn"
              class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-neutral-700 transition-colors"
            >
              Sign out
            </button>
          </div>
        </div>
      </div>
    ) : (
      <!-- Logged Out: Login/Signup buttons -->
      <div class="flex items-center gap-3">
        <a 
          href="/login" 
          class="text-sm font-medium text-gray-300 hover:text-white transition-colors nav-link"
        >
          Sign In
        </a>
        <a 
          href="/signup" 
          class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2 transition-colors"
        >
          Sign Up
        </a>
      </div>
    )}
  </div>
</nav>

<style>
  .nav-link {
    font-family: 'Schibsted Grotesk', sans-serif;
    font-weight: 700;
    font-style: normal;
    font-size: 16px;
    line-height: 11.95px;
    letter-spacing: -0.04em;
    text-align: center;
    vertical-align: middle;
  }
</style>

<script>
  import { authClient } from '../lib/auth-client';

  document.addEventListener('DOMContentLoaded', () => {
    const menuBtn = document.getElementById('user-menu-btn');
    const dropdown = document.getElementById('user-dropdown');
    const logoutBtn = document.getElementById('logout-btn');

    if (menuBtn && dropdown) {
      // Toggle dropdown
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target as Node) && !menuBtn.contains(e.target as Node)) {
          dropdown.classList.add('hidden');
        }
      });

      // Close dropdown on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          dropdown.classList.add('hidden');
        }
      });
    }

    // Logout handler
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          await authClient.signOut();
          window.location.href = '/';
        } catch (error) {
          console.error('Logout failed:', error);
          // Force reload to clear state
          window.location.href = '/';
        }
      });
    }
  });
</script>
