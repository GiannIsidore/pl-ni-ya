---
import Layout from "../../../layouts/Layout.astro";
import prisma from "../../../lib/prisma";

const { forumId } = Astro.params;
const forum = await prisma.forum.findUnique({
  where: {
    slug: forumId,
  },
  include: {
    threads: {
      include: {
        author: true,
        comments: {
          include: {
            author: {
              select: {
                id: true,
                username: true,
                avatar: true,
              },
            },
          },
          orderBy: {
            createdAt: 'desc',
          },
          take: 1,
        },
        likes: {
          select: {
            id: true,
          },
        },
        _count: {
          select: {
            comments: true,
          },
        },
      },
      orderBy: {
        updatedAt: 'desc',
      },
    },
  },
});

if (!forum) {
  return Astro.redirect("/forums");
}

function formatDate(date: Date): string {
  const d = new Date(date);
  const now = new Date();
  const diffMs = now.getTime() - d.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return d.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}

function stripHtml(html: string): string {
  return html.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').trim();
}

function getContentPreview(content: string, maxLength: number = 150): string {
  const text = stripHtml(content);
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}

function formatViews(views: number): string {
  if (views >= 1000000) {
    return `${(views / 1000000).toFixed(1)}M`;
  } else if (views >= 1000) {
    return `${(views / 1000).toFixed(1)}K`;
  }
  return views.toString();
}

function isNewThread(createdAt: Date): boolean {
  const now = new Date();
  const diffMs = now.getTime() - createdAt.getTime();
  const diffHours = diffMs / 3600000;
  return diffHours < 24;
}

function isHotThread(commentCount: number, likeCount: number, updatedAt: Date): boolean {
  const now = new Date();
  const diffMs = now.getTime() - updatedAt.getTime();
  const diffHours = diffMs / 3600000;
  return (commentCount >= 10 || likeCount >= 5) && diffHours < 48;
}
---

<Layout title={`PL-${forum.name}`}>
  <section class="text-white px-6 lg:px-12 pb-16 lg:pb-24 pt-16 lg:pt-24 bg-neutral-900 min-h-screen">
    <div class="max-w-7xl mx-auto">
      <!-- Back Button -->
      <div class="mb-8">
        <a 
          href="/forums" 
          class="group inline-flex items-center gap-2 text-gray-400 hover:text-white transition-all duration-300 text-sm font-medium"
        >
          <svg class="w-4 h-4 transition-transform duration-300 group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span class="relative">
            Back to Forums
            <span class="absolute bottom-0 left-0 w-0 h-px bg-white transition-all duration-300 group-hover:w-full"></span>
          </span>
        </a>
      </div>

      <!-- Forum Header -->
      <div class="mb-12">
        <h2 
          class="text-white mb-4" 
          style="font-family: 'Bebas Neue', sans-serif; font-weight: 400; font-style: normal; font-size: 113.42px; line-height: 94.64px; letter-spacing: -0.04em; vertical-align: middle;"
        >
          {forum.name}
        </h2>
        {forum.description && (
          <p 
            class="text-white mb-6" 
            style="font-family: 'Montserrat', sans-serif; font-weight: 600; font-style: normal; font-size: 24px; line-height: 22px; letter-spacing: -0.04em; vertical-align: middle;"
          >
            {forum.description}
          </p>
        )}
        <a 
          href={`/forums/${forum.slug}/new-thread`}
          class="inline-block border border-white text-white rounded-md py-2 px-6 hover:bg-white hover:text-black transition-colors text-sm font-medium"
        >
          + New Thread
        </a>
      </div>

      <!-- Threads List -->
      {forum.threads.length === 0 ? (
        <div class="bg-neutral-800 rounded-lg border border-neutral-700 p-16 text-center">
          <div class="max-w-md mx-auto">
            <svg class="w-16 h-16 mx-auto mb-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <p class="text-gray-300 text-xl mb-2 font-semibold">No threads yet</p>
            <p class="text-gray-400 text-base mb-8">Be the first to start a discussion in this forum!</p>
            <a 
              href={`/forums/${forum.slug}/new-thread`}
              class="inline-block border border-white text-white rounded-md py-3 px-8 hover:bg-white hover:text-black transition-all duration-300 text-sm font-medium transform hover:scale-105"
            >
              Create First Thread
            </a>
          </div>
        </div>
      ) : (
        <div class="space-y-4">
          {forum.threads.map((thread) => {
            const likeCount = thread.likes.length;
            const commentCount = thread._count.comments;
            const lastComment = thread.comments[0];
            const isNew = isNewThread(thread.createdAt);
            const isHot = isHotThread(commentCount, likeCount, thread.updatedAt);
            const isPopular = likeCount >= 5;
            
            return (
              <a 
                href={`/forums/${forum.slug}/${thread.slug}`}
                class="block bg-neutral-800 rounded-lg border border-neutral-700 p-6 hover:border-neutral-600 hover:bg-neutral-750 transition-all duration-300 group relative overflow-hidden"
              >
                {/* Visual Indicators */}
                {(isNew || isHot || isPopular) && (
                  <div class="absolute top-0 right-0 flex gap-2 p-3">
                    {isNew && (
                      <span class="px-2 py-1 text-xs font-semibold bg-blue-600 text-white rounded">
                        New
                      </span>
                    )}
                    {isHot && (
                      <span class="px-2 py-1 text-xs font-semibold bg-orange-600 text-white rounded">
                        Hot
                      </span>
                    )}
                    {isPopular && !isHot && (
                      <span class="px-2 py-1 text-xs font-semibold bg-purple-600 text-white rounded">
                        Popular
                      </span>
                    )}
                  </div>
                )}

                <div class="flex gap-4">
                  {/* Author Avatar */}
                  <div class="flex-shrink-0">
                    {thread.author.avatar ? (
                      <img 
                        src={thread.author.avatar} 
                        alt={thread.author.username}
                        class="w-12 h-12 rounded-full object-cover border-2 border-neutral-700 group-hover:border-blue-500 transition-colors"
                      />
                    ) : (
                      <div class="w-12 h-12 rounded-full bg-neutral-700 flex items-center justify-center border-2 border-neutral-700 group-hover:border-blue-500 transition-colors">
                        <svg class="w-6 h-6 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                      </div>
                    )}
                  </div>

                  {/* Content */}
                  <div class="flex-1 min-w-0">
                    {/* Author & Metadata Row */}
                    <div class="flex items-center gap-3 mb-2 flex-wrap">
                      <span class="text-white font-semibold text-sm">
                        {thread.author.username}
                      </span>
                      <span class="text-gray-500 text-xs">
                        {formatDate(thread.createdAt)}
                      </span>
                      {likeCount > 0 && (
                        <span class="flex items-center gap-1 text-gray-400 text-xs">
                          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                          </svg>
                          {likeCount}
                        </span>
                      )}
                      {/* Mobile timestamp */}
                      <span class="text-gray-500 text-xs lg:hidden ml-auto">
                        {formatDate(thread.updatedAt)}
                      </span>
                    </div>

                    {/* Thread Title */}
                    <h3 
                      class="text-white font-semibold text-xl lg:text-2xl mb-3 group-hover:text-blue-400 transition-colors line-clamp-2"
                      style="font-family: 'Bebas Neue', sans-serif; font-weight: 400; letter-spacing: -0.02em;"
                    >
                      {thread.title}
                    </h3>

                    {/* Content Preview */}
                    {thread.content && (
                      <p class="text-gray-400 text-sm mb-4 line-clamp-2 leading-relaxed">
                        {getContentPreview(thread.content)}
                      </p>
                    )}

                    {/* Stats Row */}
                    <div class="flex items-center gap-4 text-gray-400 text-xs lg:text-sm flex-wrap">
                      <span class="flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        {commentCount} {commentCount === 1 ? 'comment' : 'comments'}
                      </span>
                      <span class="flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        {formatViews(thread.views)} views
                      </span>
                      {lastComment && (
                        <span class="flex items-center gap-1.5 text-gray-500">
                          <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                          </svg>
                          <span class="hidden sm:inline">Last reply by {lastComment.author.username} â€¢ {formatDate(lastComment.createdAt)}</span>
                          <span class="sm:hidden">Reply {formatDate(lastComment.createdAt)}</span>
                        </span>
                      )}
                    </div>
                  </div>

                  {/* Desktop Timestamp */}
                  <div class="hidden lg:flex flex-shrink-0 text-gray-500 text-xs lg:text-sm self-start pt-1">
                    {formatDate(thread.updatedAt)}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  /* Line clamp utilities for content preview */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Enhanced hover effects */
  .group:hover .group-hover\:border-blue-500 {
    border-color: rgb(59 130 246);
  }

  /* Smooth transitions for badges */
  .bg-blue-600,
  .bg-orange-600,
  .bg-purple-600 {
    transition: opacity 0.2s ease-in-out;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .thread-card-content {
      flex-direction: column;
    }
  }
</style>
