---
import Layout from "../../../layouts/Layout.astro";
import prisma from "../../../lib/prisma";

const { forumId } = Astro.params;
const forum = await prisma.forum.findUnique({
  where: {
    slug: forumId,
  },
  include: {
    threads: {
      include: {
        author: true,
        comments: {
          select: {
            id: true,
          },
        },
      },
      orderBy: {
        updatedAt: 'desc',
      },
    },
  },
});

if (!forum) {
  return Astro.redirect("/forums");
}

function formatDate(date: Date): string {
  const d = new Date(date);
  const now = new Date();
  const diffMs = now.getTime() - d.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return d.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}
---

<Layout title={`PL-${forum.name}`}>
  <section class="text-white px-6 lg:px-12 pb-16 lg:pb-24 pt-16 lg:pt-24 bg-neutral-900 min-h-screen">
    <div class="max-w-7xl mx-auto">
      <!-- Back Button -->
      <div class="mb-8">
        <a 
          href="/forums" 
          class="group inline-flex items-center gap-2 text-gray-400 hover:text-white transition-all duration-300 text-sm font-medium"
        >
          <svg class="w-4 h-4 transition-transform duration-300 group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span class="relative">
            Back to Forums
            <span class="absolute bottom-0 left-0 w-0 h-px bg-white transition-all duration-300 group-hover:w-full"></span>
          </span>
        </a>
      </div>

      <!-- Forum Header -->
      <div class="mb-12">
        <h2 
          class="text-white mb-4" 
          style="font-family: 'Bebas Neue', sans-serif; font-weight: 400; font-style: normal; font-size: 113.42px; line-height: 94.64px; letter-spacing: -0.04em; vertical-align: middle;"
        >
          {forum.name}
        </h2>
        {forum.description && (
          <p 
            class="text-white mb-6" 
            style="font-family: 'Montserrat', sans-serif; font-weight: 600; font-style: normal; font-size: 24px; line-height: 22px; letter-spacing: -0.04em; vertical-align: middle;"
          >
            {forum.description}
          </p>
        )}
        <a 
          href={`/forums/${forum.slug}/new-thread`}
          class="inline-block border border-white text-white rounded-md py-2 px-6 hover:bg-white hover:text-black transition-colors text-sm font-medium"
        >
          + New Thread
        </a>
      </div>

      <!-- Threads List -->
      {forum.threads.length === 0 ? (
        <div class="bg-neutral-800 rounded-lg border border-neutral-700 p-12 text-center">
          <p class="text-gray-400 text-lg mb-4">No threads yet. Be the first to start a discussion!</p>
          <a 
            href={`/forums/${forum.slug}/new-thread`}
            class="inline-block border border-white text-white rounded-md py-2 px-6 hover:bg-white hover:text-black transition-colors text-sm font-medium"
          >
            Create First Thread
          </a>
        </div>
      ) : (
        <div class="space-y-4">
          {forum.threads.map((thread) => (
            <a 
              href={`/forums/${forum.slug}/${thread.slug}`}
              class="block bg-neutral-800 rounded-lg border border-neutral-700 p-6 hover:border-neutral-600 hover:bg-neutral-750 transition-all group"
            >
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <h3 class="text-white font-semibold text-lg lg:text-xl mb-2 group-hover:text-blue-400 transition-colors">
                    {thread.title}
                  </h3>
                  <div class="flex items-center gap-4 text-gray-400 text-xs lg:text-sm mb-3">
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      {thread.author.username}
                    </span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                      </svg>
                      {thread.comments.length} {thread.comments.length === 1 ? 'comment' : 'comments'}
                    </span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      {thread.views} {thread.views === 1 ? 'view' : 'views'}
                    </span>
                  </div>
                </div>
                <div class="flex-shrink-0 text-gray-500 text-xs lg:text-sm">
                  {formatDate(thread.updatedAt)}
                </div>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
  </section>
</Layout>
