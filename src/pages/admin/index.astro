---
import AdminLayout from "../../layouts/AdminLayout.astro";

// Get user info for welcome message - defensive approach
const locals = Astro.locals as any;
const user = locals?.user;
const username = user?.username || user?.name || "Admin";

// Default stats in case API fails
let stats = {
	totalUsers: 0,
	newUsers: 0,
	totalBlogs: 0,
	blogViews: 0,
	totalThreads: 0,
	totalComments: 0,
	pendingModeration: 0,
	recentActivity: [],
	systemHealth: {
		database: "healthy",
		uptime: "99.9%",
		lastBackup: "2 hours ago",
	},
};

// Try to fetch dashboard statistics
try {
	const siteOrigin = Astro.site?.origin || "http://localhost:4322";
	const response = await fetch(`${siteOrigin}/api/admin/stats`, {
		headers: {
			Cookie: Astro.request.headers.get("cookie") || "",
		},
	});

	if (response.ok) {
		const apiStats = await response.json();
		stats = { ...stats, ...apiStats };
	}
} catch (error) {
	console.error("Failed to fetch admin stats:", error);
	// Use default stats
}
---

<AdminLayout title="Admin Dashboard">
	<div class="space-y-10 pb-12">
		<!-- Welcome Header -->
		<div
			class="relative overflow-hidden rounded-3xl bg-neutral-900 border border-neutral-800 p-10 shadow-2xl"
		>
			<div class="relative z-10">
				<h1
					class="text-5xl font-normal text-white mb-3 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					WELCOME BACK, <span class="text-blue-500 uppercase"
						>{username}</span
					>!
				</h1>
				<p
					class="text-neutral-400 max-w-2xl text-lg leading-relaxed"
					style="font-family: 'Schibsted Grotesk', sans-serif;"
				>
					Your platform is running smoothly. Here's a comprehensive
					overview of your community's performance and recent
					activity.
				</p>
			</div>
			<!-- Background Decorative Elements -->
			<div
				class="absolute top-0 right-0 w-1/3 h-full bg-gradient-to-l from-blue-600/10 to-transparent"
			>
			</div>
			<div
				class="absolute -bottom-24 -right-24 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"
			>
			</div>
		</div>

		<!-- Statistics Grid -->
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
			<!-- Total Users -->
			<div
				class="group bg-neutral-900 rounded-3xl p-8 border border-neutral-800 hover:border-blue-500/50 transition-all duration-300 shadow-xl"
			>
				<div class="flex items-center justify-between mb-6">
					<div
						class="w-14 h-14 bg-blue-600/10 rounded-2xl flex items-center justify-center group-hover:bg-blue-600 transition-colors duration-300"
					>
						<svg
							class="w-7 h-7 text-blue-500 group-hover:text-white transition-colors"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
							></path>
						</svg>
					</div>
					<div class="px-3 py-1 bg-green-500/10 rounded-full">
						<span class="text-xs text-green-500 font-bold"
							>+{stats.newUsers}</span
						>
					</div>
				</div>
				<h3
					class="text-4xl font-normal text-white mb-2 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					{stats.totalUsers.toLocaleString()}
				</h3>
				<p
					class="text-neutral-500 text-xs font-bold uppercase tracking-widest"
					style="font-family: 'Schibsted Grotesk', sans-serif;"
				>
					Total Users
				</p>
			</div>

			<!-- Total Blogs -->
			<div
				class="group bg-neutral-900 rounded-3xl p-8 border border-neutral-800 hover:border-purple-500/50 transition-all duration-300 shadow-xl"
			>
				<div class="flex items-center justify-between mb-6">
					<div
						class="w-14 h-14 bg-purple-600/10 rounded-2xl flex items-center justify-center group-hover:bg-purple-600 transition-colors duration-300"
					>
						<svg
							class="w-7 h-7 text-purple-500 group-hover:text-white transition-colors"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
							></path>
						</svg>
					</div>
					<div class="px-3 py-1 bg-neutral-800 rounded-full">
						<span
							class="text-xs text-neutral-400 font-bold uppercase tracking-tighter"
							>Blogs</span
						>
					</div>
				</div>
				<h3
					class="text-4xl font-normal text-white mb-2 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					{stats.totalBlogs.toLocaleString()}
				</h3>
				<p
					class="text-neutral-500 text-xs font-bold uppercase tracking-widest"
					style="font-family: 'Schibsted Grotesk', sans-serif;"
				>
					Published Posts
				</p>
			</div>

			<!-- Total Threads -->
			<div
				class="group bg-neutral-900 rounded-3xl p-8 border border-neutral-800 hover:border-green-500/50 transition-all duration-300 shadow-xl"
			>
				<div class="flex items-center justify-between mb-6">
					<div
						class="w-14 h-14 bg-green-600/10 rounded-2xl flex items-center justify-center group-hover:bg-green-600 transition-colors duration-300"
					>
						<svg
							class="w-7 h-7 text-green-500 group-hover:text-white transition-colors"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994-.586.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"
							></path>
						</svg>
					</div>
					<div class="px-3 py-1 bg-green-500/10 rounded-full">
						<span class="text-xs text-green-500 font-bold"
							>Active</span
						>
					</div>
				</div>
				<h3
					class="text-4xl font-normal text-white mb-2 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					{stats.totalThreads.toLocaleString()}
				</h3>
				<p
					class="text-neutral-500 text-xs font-bold uppercase tracking-widest"
					style="font-family: 'Schibsted Grotesk', sans-serif;"
				>
					Forum Threads
				</p>
			</div>

			<!-- Pending Moderation -->
			<div
				class="group bg-neutral-900 rounded-3xl p-8 border border-neutral-800 hover:border-orange-500/50 transition-all duration-300 shadow-xl"
			>
				<div class="flex items-center justify-between mb-6">
					<div
						class="w-14 h-14 bg-orange-600/10 rounded-2xl flex items-center justify-center group-hover:bg-orange-600 transition-colors duration-300"
					>
						<svg
							class="w-7 h-7 text-orange-500 group-hover:text-white transition-colors"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
							></path>
						</svg>
					</div>
					{
						stats.pendingModeration > 0 && (
							<div class="px-3 py-1 bg-red-500/10 rounded-full animate-bounce">
								<span class="text-xs text-red-500 font-bold">
									Pending
								</span>
							</div>
						)
					}
				</div>
				<h3
					class="text-4xl font-normal text-white mb-2 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					{stats.pendingModeration}
				</h3>
				<p
					class="text-neutral-500 text-xs font-bold uppercase tracking-widest"
					style="font-family: 'Schibsted Grotesk', sans-serif;"
				>
					Needs Review
				</p>
			</div>
		</div>

		<!-- Quick Actions -->
		<div
			class="bg-neutral-900 rounded-3xl p-10 border border-neutral-800 shadow-xl"
		>
			<h2
				class="text-3xl font-normal text-white mb-8 tracking-tight"
				style="font-family: 'Bebas Neue', sans-serif;"
			>
				Admin Quick Actions
			</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
				<a
					href="/admin/blogs/create"
					class="group flex flex-col gap-4 p-6 bg-neutral-800/50 rounded-2xl hover:bg-blue-600 transition-all duration-300 border border-neutral-700/50 hover:border-blue-400 shadow-lg"
				>
					<div
						class="w-12 h-12 bg-blue-600/20 rounded-xl flex items-center justify-center group-hover:bg-white group-hover:scale-110 transition-all duration-300"
					>
						<svg
							class="w-6 h-6 text-blue-400 group-hover:text-blue-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 4v16m8-8H4"></path>
						</svg>
					</div>
					<div>
						<span
							class="text-white font-bold text-lg group-hover:text-white transition-colors"
							style="font-family: 'Schibsted Grotesk', sans-serif;"
							>Create Blog</span
						>
						<p
							class="text-neutral-500 text-xs mt-1 group-hover:text-blue-100 transition-colors"
						>
							Write a new article
						</p>
					</div>
				</a>

				<a
					href="/admin/users"
					class="group flex flex-col gap-4 p-6 bg-neutral-800/50 rounded-2xl hover:bg-green-600 transition-all duration-300 border border-neutral-700/50 hover:border-green-400 shadow-lg"
				>
					<div
						class="w-12 h-12 bg-green-600/20 rounded-xl flex items-center justify-center group-hover:bg-white group-hover:scale-110 transition-all duration-300"
					>
						<svg
							class="w-6 h-6 text-green-400 group-hover:text-green-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
							></path>
						</svg>
					</div>
					<div>
						<span
							class="text-white font-bold text-lg group-hover:text-white transition-colors"
							style="font-family: 'Schibsted Grotesk', sans-serif;"
							>User List</span
						>
						<p
							class="text-neutral-500 text-xs mt-1 group-hover:text-green-100 transition-colors"
						>
							Manage user base
						</p>
					</div>
				</a>

				<a
					href="/admin/reports"
					class="group flex flex-col gap-4 p-6 bg-neutral-800/50 rounded-2xl hover:bg-orange-600 transition-all duration-300 border border-neutral-700/50 hover:border-orange-400 shadow-lg"
				>
					<div
						class="w-12 h-12 bg-orange-600/20 rounded-xl flex items-center justify-center group-hover:bg-white group-hover:scale-110 transition-all duration-300"
					>
						<svg
							class="w-6 h-6 text-orange-400 group-hover:text-orange-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
							></path>
						</svg>
					</div>
					<div>
						<span
							class="text-white font-bold text-lg group-hover:text-white transition-colors"
							style="font-family: 'Schibsted Grotesk', sans-serif;"
							>Reports</span
						>
						<p
							class="text-neutral-500 text-xs mt-1 group-hover:text-orange-100 transition-colors"
						>
							Audit flagging reports
						</p>
					</div>
				</a>

				<a
					href="/admin/analytics"
					class="group flex flex-col gap-4 p-6 bg-neutral-800/50 rounded-2xl hover:bg-purple-600 transition-all duration-300 border border-neutral-700/50 hover:border-purple-400 shadow-lg"
				>
					<div
						class="w-12 h-12 bg-purple-600/20 rounded-xl flex items-center justify-center group-hover:bg-white group-hover:scale-110 transition-all duration-300"
					>
						<svg
							class="w-6 h-6 text-purple-400 group-hover:text-purple-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
							></path>
						</svg>
					</div>
					<div>
						<span
							class="text-white font-bold text-lg group-hover:text-white transition-colors"
							style="font-family: 'Schibsted Grotesk', sans-serif;"
							>Analytics</span
						>
						<p
							class="text-neutral-500 text-xs mt-1 group-hover:text-purple-100 transition-colors"
						>
							Platform metrics
						</p>
					</div>
				</a>
			</div>
		</div>

		<!-- Recent Activity & System Health -->
		<div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
			<!-- Recent Activity -->
			<div
				class="bg-neutral-900 rounded-3xl p-10 border border-neutral-800 shadow-xl overflow-hidden relative"
			>
				<h2
					class="text-3xl font-normal text-white mb-8 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					Recent Activity
				</h2>
				<div class="space-y-6 relative z-10">
					{
						stats.recentActivity.length > 0 ? (
							stats.recentActivity.map((activity: any) => (
								<div class="group flex items-start gap-4 p-5 bg-neutral-800/50 rounded-2xl border border-neutral-700/30 hover:border-blue-500/30 transition-all duration-300">
									<div class="w-10 h-10 bg-blue-600/10 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:bg-blue-600 transition-colors">
										<svg
											class="w-5 h-5 text-blue-500 group-hover:text-white"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
											/>
										</svg>
									</div>
									<div class="flex-1 min-w-0">
										<p
											class="text-sm text-neutral-200 leading-relaxed font-medium"
											style="font-family: 'Schibsted Grotesk', sans-serif;"
										>
											{activity.description}
										</p>
										<p class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest mt-2 bg-neutral-900 w-fit px-2 py-1 rounded-md">
											{activity.timestamp}
										</p>
									</div>
								</div>
							))
						) : (
							<div class="text-center py-16">
								<div class="w-20 h-20 bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-6">
									<svg
										class="w-10 h-10 text-neutral-600"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
										/>
									</svg>
								</div>
								<p
									class="text-neutral-500 font-bold tracking-widest uppercase text-xs"
									style="font-family: 'Schibsted Grotesk', sans-serif;"
								>
									Quiet on the front scales
								</p>
							</div>
						)
					}
				</div>
				<div
					class="absolute -bottom-10 -left-10 w-40 h-40 bg-blue-600/5 rounded-full blur-3xl"
				>
				</div>
			</div>

			<!-- System Health -->
			<div
				class="bg-neutral-900 rounded-3xl p-10 border border-neutral-800 shadow-xl relative overflow-hidden"
			>
				<h2
					class="text-3xl font-normal text-white mb-8 tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					System Integrity
				</h2>
				<div class="space-y-8 relative z-10">
					<div
						class="p-6 bg-neutral-800/30 rounded-2xl border border-neutral-700/20"
					>
						<div class="flex items-center justify-between mb-4">
							<div class="flex items-center gap-3">
								<div class="w-2 h-2 rounded-full bg-green-500">
								</div>
								<span
									class="text-sm font-bold text-neutral-400 uppercase tracking-widest shadow-sm"
									style="font-family: 'Schibsted Grotesk', sans-serif;"
									>Database</span
								>
							</div>
							<span
								class="px-3 py-1 text-[10px] font-bold rounded-lg bg-green-500/10 text-green-500 uppercase tracking-widest border border-green-500/20"
								>Operational</span
							>
						</div>
						<div
							class="flex items-center justify-between font-bold"
							style="font-family: 'Schibsted Grotesk', sans-serif;"
						>
							<span class="text-neutral-200">Latency</span>
							<span class="text-white text-sm"
								>4ms <span
									class="text-green-500 font-normal ml-1"
									>Excellent</span
								></span
							>
						</div>
					</div>

					<div class="grid grid-cols-2 gap-4">
						<div
							class="p-6 bg-neutral-800/30 rounded-2xl border border-neutral-700/20 text-center"
						>
							<p
								class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest mb-2"
							>
								Network Uptime
							</p>
							<p
								class="text-2xl font-normal text-white"
								style="font-family: 'Bebas Neue', sans-serif;"
							>
								99.98%
							</p>
						</div>
						<div
							class="p-6 bg-neutral-800/30 rounded-2xl border border-neutral-700/20 text-center"
						>
							<p
								class="text-[10px] text-neutral-500 font-bold uppercase tracking-widest mb-2"
							>
								Build Version
							</p>
							<p
								class="text-2xl font-normal text-blue-500"
								style="font-family: 'Bebas Neue', sans-serif;"
							>
								v1.4.2
							</p>
						</div>
					</div>

					<div class="space-y-6">
						<div>
							<div class="flex items-center justify-between mb-2">
								<span
									class="text-[10px] font-bold text-neutral-400 uppercase tracking-widest"
									style="font-family: 'Schibsted Grotesk', sans-serif;"
									>CPU Utilization</span
								>
								<span class="text-xs font-bold text-white"
									>42%</span
								>
							</div>
							<div
								class="w-full h-1.5 bg-neutral-800 rounded-full overflow-hidden"
							>
								<div
									class="w-[42%] h-full bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"
								>
								</div>
							</div>
						</div>
						<div>
							<div class="flex items-center justify-between mb-2">
								<span
									class="text-[10px] font-bold text-neutral-400 uppercase tracking-widest"
									style="font-family: 'Schibsted Grotesk', sans-serif;"
									>Heap Memory</span
								>
								<span class="text-xs font-bold text-white"
									>2.4 GB / 8 GB</span
								>
							</div>
							<div
								class="w-full h-1.5 bg-neutral-800 rounded-full overflow-hidden"
							>
								<div
									class="w-[30%] h-full bg-gradient-to-r from-purple-600 to-purple-400 rounded-full"
								>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div
					class="absolute -top-10 -right-10 w-40 h-40 bg-blue-600/5 rounded-full blur-3xl"
				>
				</div>
			</div>
		</div>
	</div>
</AdminLayout>
