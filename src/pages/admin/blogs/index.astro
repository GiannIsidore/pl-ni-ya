---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { getBlogs } from "../../../lib/services/blogs";

const page = Number(Astro.url.searchParams.get("page")) || 1;
const limit = 12; // 12 works well for 2, 3, 4 column grids
const status = Astro.url.searchParams.get("status") || "all";
const search = Astro.url.searchParams.get("search") || "";
const view = Astro.url.searchParams.get("view") || "table";

const { blogs, total, totalPages } = await getBlogs({
	page,
	limit,
	status: status === "all" ? undefined : status,
	search,
});

const pages = Array.from({ length: totalPages }, (_, i) => i + 1);
---

<AdminLayout title="Manage Blogs">
	<div class="space-y-6">
		<!-- Header -->
		<div
			class="flex flex-col md:flex-row md:items-center justify-between gap-4"
		>
			<div>
				<h1
					class="text-4xl font-normal text-white tracking-tight"
					style="font-family: 'Bebas Neue', sans-serif;"
				>
					All Posts
				</h1>
				<p
					class="text-neutral-400 text-sm mt-1"
					style="font-family: 'Schibsted Grotesk', sans-serif;"
				>
					Manage, edit, and publish your content
				</p>
			</div>
			<a
				href="/admin/blogs/create"
				class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-blue-600/25 group"
			>
				<svg
					class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M12 4v16m8-8H4"></path>
				</svg>
				<span style="font-family: 'Schibsted Grotesk', sans-serif;"
					>Create New</span
				>
			</a>
		</div>

		<!-- Filters & Controls -->
		<div
			class="bg-neutral-900 border border-neutral-800 rounded-2xl p-4 flex flex-col lg:flex-row gap-4 items-center justify-between shadow-lg"
		>
			<!-- Search & Filter -->
			<form
				class="flex flex-1 w-full lg:w-auto flex-col sm:flex-row gap-3 items-center"
				method="get"
			>
				<input type="hidden" name="view" value={view} />

				<!-- Search Input Group -->
				<div class="flex w-full max-w-md gap-2">
					<div class="relative flex-1 group">
						<div
							class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
						>
							<svg
								class="h-4 w-4 text-neutral-500 group-focus-within:text-blue-500 transition-colors"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
								></path>
							</svg>
						</div>
						<input
							type="text"
							name="search"
							value={search}
							placeholder="Search posts by title..."
							class="block w-full pl-10 pr-3 h-10 bg-neutral-800 border border-neutral-700 rounded-xl text-white text-sm placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-all"
						/>
					</div>
					<button
						type="submit"
						class="px-4 h-10 bg-neutral-700 hover:bg-neutral-600 text-white text-xs font-bold uppercase tracking-widest rounded-xl transition-all border border-neutral-600"
					>
						Search
					</button>
				</div>

				<!-- Status Filter -->
				<div class="relative w-full sm:w-[180px]">
					<select
						name="status"
						onchange="this.form.submit()"
						class="block w-full pl-3 pr-10 h-10 bg-neutral-800 border border-neutral-700 rounded-xl text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 appearance-none cursor-pointer hover:bg-neutral-700/50 transition-colors"
					>
						<option value="all" selected={status === "all"}
							>All Status</option
						>
						<option
							value="published"
							selected={status === "published"}>Published</option
						>
						<option value="draft" selected={status === "draft"}
							>Draft</option
						>
						<option
							value="archived"
							selected={status === "archived"}>Archived</option
						>
					</select>
					<div
						class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-neutral-500"
					>
						<svg
							class="h-4 w-4"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M19 9l-7 7-7-7"></path>
						</svg>
					</div>
				</div>
			</form>

			<!-- View Toggle -->
			<div
				class="flex items-center h-10 bg-neutral-800 p-1 rounded-xl border border-neutral-700 ring-1 ring-neutral-700/50"
			>
				<a
					href={`?page=${page}&status=${status}&search=${search}&view=table`}
					class={`h-8 px-3 flex items-center justify-center rounded-lg transition-all ${view === "table" ? "bg-neutral-700 text-white shadow-lg ring-1 ring-neutral-600" : "text-neutral-500 hover:text-white hover:bg-neutral-700/50"}`}
					title="Table View"
				>
					<svg
						class="w-4 h-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
					</svg>
				</a>
				<a
					href={`?page=${page}&status=${status}&search=${search}&view=card`}
					class={`h-8 px-3 flex items-center justify-center rounded-lg transition-all ${view === "card" ? "bg-neutral-700 text-white shadow-lg ring-1 ring-neutral-600" : "text-neutral-500 hover:text-white hover:bg-neutral-700/50"}`}
					title="Card View"
				>
					<svg
						class="w-4 h-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
						></path>
					</svg>
				</a>
			</div>
		</div>

		<!-- Content -->
		{
			blogs.length === 0 ? (
				<div class="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-16 text-center">
					<div class="w-20 h-20 bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-6">
						<svg
							class="w-10 h-10 text-neutral-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
							/>
						</svg>
					</div>
					<h3 class="text-xl font-bold text-white mb-2">
						No posts found
					</h3>
					<p class="text-neutral-400 mb-6">
						Try adjusting your search or filters, or create a new
						post.
					</p>
					<a
						href="/admin/blogs/create"
						class="inline-flex items-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl transition-colors"
					>
						Create Post
					</a>
				</div>
			) : view === "table" ? (
				// Industry Standard Table View
				<div class="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden shadow-2xl">
					<div class="overflow-x-auto">
						<table class="w-full text-left border-collapse table-auto">
							<thead>
								<tr class="bg-neutral-800/40 border-b border-neutral-800 text-neutral-500 text-[10px] uppercase tracking-[0.15em] font-bold">
									<th class="px-6 py-4 w-[40%]">
										Content Details
									</th>
									<th class="px-6 py-4 w-[20%]">Author</th>
									<th class="px-6 py-4 w-[15%]">Status</th>
									<th class="px-6 py-4 w-[15%]">
										Published Date
									</th>
									<th class="px-6 py-4 w-[10%] text-right">
										Actions
									</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-neutral-800/50">
								{blogs.map((blog) => (
									<tr class="group hover:bg-neutral-800/20 transition-all duration-200">
										<td class="px-6 py-5">
											<div class="flex items-center gap-4">
												<div class="relative flex-shrink-0">
													{blog.featuredImage ? (
														<img
															src={
																blog
																	.featuredImage
																	.url
															}
															alt={blog.title}
															class="w-14 h-14 rounded-xl object-cover ring-1 ring-neutral-700 shadow-lg group-hover:ring-blue-500/50 transition-all"
														/>
													) : (
														<div class="w-14 h-14 rounded-xl bg-neutral-800 flex items-center justify-center text-neutral-600 ring-1 ring-neutral-700">
															<svg
																class="w-6 h-6"
																fill="none"
																stroke="currentColor"
																viewBox="0 0 24 24"
															>
																<path
																	stroke-linecap="round"
																	stroke-linejoin="round"
																	stroke-width="1.5"
																	d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
																/>
															</svg>
														</div>
													)}
												</div>
												<div class="min-w-0">
													<div
														class="text-white font-semibold text-sm group-hover:text-blue-400 transition-colors truncate max-w-[300px]"
														style="font-family: 'Schibsted Grotesk', sans-serif;"
													>
														{blog.title}
													</div>
													<div class="text-neutral-500 text-xs mt-1 truncate max-w-[280px]">
														{blog.excerpt ||
															"No description provided..."}
													</div>
												</div>
											</div>
										</td>
										<td class="px-6 py-5">
											<div class="flex items-center gap-3">
												<div class="relative flex-shrink-0">
													{blog.author?.avatar ? (
														<img
															src={
																blog.author
																	.avatar
															}
															alt={
																blog.author
																	.username ||
																"User"
															}
															class="w-8 h-8 rounded-full object-cover ring-1 ring-neutral-700"
														/>
													) : (
														<div class="w-8 h-8 rounded-full bg-blue-600/10 flex items-center justify-center text-[11px] text-blue-500 font-bold ring-1 ring-blue-500/20">
															{(
																blog.author
																	?.username ||
																"U"
															)
																.charAt(0)
																.toUpperCase()}
														</div>
													)}
												</div>
												<span
													class="text-neutral-300 text-sm font-medium"
													style="font-family: 'Schibsted Grotesk', sans-serif;"
												>
													{blog.author?.username ||
														"Unknown"}
												</span>
											</div>
										</td>
										<td class="px-6 py-5">
											<span
												class={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border transition-colors ${
													blog.status === "PUBLISHED"
														? "bg-green-500/5 text-green-500 border-green-500/20"
														: blog.status ===
															  "DRAFT"
															? "bg-neutral-500/5 text-neutral-400 border-neutral-500/20"
															: "bg-orange-500/5 text-orange-500 border-orange-500/20"
												}`}
											>
												<span
													class={`w-1.5 h-1.5 rounded-full ${
														blog.status ===
														"PUBLISHED"
															? "bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"
															: blog.status ===
																  "DRAFT"
																? "bg-neutral-500"
																: "bg-orange-500 shadow-[0_0_8px_rgba(249,115,22,0.6)]"
													}`}
												/>
												{blog.status}
											</span>
										</td>
										<td class="px-6 py-5">
											<div class="flex flex-col">
												<span class="text-neutral-300 text-sm font-medium">
													{new Date(
														blog.createdAt,
													).toLocaleDateString(
														undefined,
														{
															month: "short",
															day: "numeric",
															year: "numeric",
														},
													)}
												</span>
												<span class="text-neutral-500 text-[10px] uppercase font-bold tracking-tight mt-0.5">
													{new Date(
														blog.createdAt,
													).toLocaleTimeString(
														undefined,
														{
															hour: "2-digit",
															minute: "2-digit",
														},
													)}
												</span>
											</div>
										</td>
										<td class="px-6 py-5 text-right">
											<div class="flex items-center justify-end gap-1">
												<a
													href={`/admin/blogs/edit/${blog.id}`}
													class="p-2 text-neutral-400 hover:text-white hover:bg-neutral-800 rounded-lg transition-all"
													title="Edit Post"
												>
													<svg
														class="w-5 h-5"
														fill="none"
														stroke="currentColor"
														viewBox="0 0 24 24"
													>
														<path
															stroke-linecap="round"
															stroke-linejoin="round"
															stroke-width="2"
															d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
														/>
													</svg>
												</a>
												<button
													type="button"
													data-id={blog.id}
													data-title={blog.title}
													class="delete-btn p-2 text-neutral-400 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all"
													title="Delete Post"
												>
													<svg
														class="w-5 h-5"
														fill="none"
														stroke="currentColor"
														viewBox="0 0 24 24"
													>
														<path
															stroke-linecap="round"
															stroke-linejoin="round"
															stroke-width="2"
															d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
														/>
													</svg>
												</button>
											</div>
										</td>
									</tr>
								))}
							</tbody>
						</table>
					</div>
				</div>
			) : (
				// Card View
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
					{blogs.map((blog) => (
						<div class="group bg-neutral-900 rounded-2xl border border-neutral-800 overflow-hidden hover:border-blue-500/50 hover:shadow-2xl hover:shadow-blue-500/10 transition-all duration-300 flex flex-col h-full">
							<div class="relative h-48 bg-neutral-800 overflow-hidden">
								{blog.featuredImage ? (
									<img
										src={blog.featuredImage.url}
										alt={blog.title}
										class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
									/>
								) : (
									<div class="w-full h-full flex items-center justify-center text-neutral-700">
										<svg
											class="w-16 h-16"
											fill="none"
											stroke="currentColor"
											viewBox="0 0 24 24"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="1.5"
												d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
											/>
										</svg>
									</div>
								)}
								<div class="absolute top-3 right-3">
									<span
										class={`px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wide backdrop-blur-md shadow-lg ${
											blog.status === "PUBLISHED"
												? "bg-green-500/90 text-white"
												: blog.status === "DRAFT"
													? "bg-neutral-500/90 text-white"
													: "bg-orange-500/90 text-white"
										}`}
									>
										{blog.status}
									</span>
								</div>
							</div>
							<div class="p-5 flex-1 flex flex-col">
								<h3
									class="text-xl font-bold text-white mb-2 line-clamp-2 leading-tight group-hover:text-blue-400 transition-colors"
									style="font-family: 'Schibsted Grotesk', sans-serif;"
								>
									{blog.title}
								</h3>
								<p class="text-neutral-400 text-sm line-clamp-3 mb-4 flex-1">
									{blog.excerpt || "No excerpt available."}
								</p>
								<div class="flex items-center justify-between mt-auto pt-4 border-t border-neutral-800">
									<div class="flex items-center gap-2">
										<span class="text-xs text-neutral-500">
											{new Date(
												blog.createdAt,
											).toLocaleDateString()}
										</span>
									</div>
									<div class="flex gap-2">
										<a
											href={`/admin/blogs/edit/${blog.id}`}
											class="p-2 text-neutral-400 hover:text-white hover:bg-neutral-800 rounded-lg transition-colors"
										>
											<svg
												class="w-4 h-4"
												fill="none"
												stroke="currentColor"
												viewBox="0 0 24 24"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
												/>
											</svg>
										</a>
										<button
											type="button"
											data-id={blog.id}
											data-title={blog.title}
											class="delete-btn p-2 text-neutral-400 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"
										>
											<svg
												class="w-4 h-4"
												fill="none"
												stroke="currentColor"
												viewBox="0 0 24 24"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
												/>
											</svg>
										</button>
									</div>
								</div>
							</div>
						</div>
					))}
				</div>
			)
		}

		<!-- Pagination -->
		{
			totalPages > 1 && (
				<div class="flex items-center justify-between border-t border-neutral-800 pt-6">
					<p class="text-sm text-neutral-500">
						Showing{" "}
						<span class="font-medium text-white">
							{(page - 1) * limit + 1}
						</span>{" "}
						to{" "}
						<span class="font-medium text-white">
							{Math.min(page * limit, total)}
						</span>{" "}
						of <span class="font-medium text-white">{total}</span>{" "}
						results
					</p>
					<div class="flex gap-2">
						{page > 1 && (
							<a
								href={`?page=${page - 1}&status=${status}&search=${search}&view=${view}`}
								class="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg transition-colors text-sm font-medium"
							>
								Previous
							</a>
						)}
						<div class="flex gap-1">
							{pages.map((p) => (
								<a
									href={`?page=${p}&status=${status}&search=${search}&view=${view}`}
									class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${p === page ? "bg-blue-600 text-white" : "bg-neutral-800 text-neutral-400 hover:bg-neutral-700 hover:text-white"}`}
								>
									{p}
								</a>
							))}
						</div>
						{page < totalPages && (
							<a
								href={`?page=${page + 1}&status=${status}&search=${search}&view=${view}`}
								class="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg transition-colors text-sm font-medium"
							>
								Next
							</a>
						)}
					</div>
				</div>
			)
		}
	</div>

	<!-- Delete Confirmation Modal -->
	<dialog
		id="delete-modal"
		class="bg-transparent p-0 w-full h-full max-w-none max-h-none backdrop:bg-black/80 z-50 open:flex items-center justify-center fixed inset-0 hidden"
	>
		<div
			class="bg-neutral-900 border border-neutral-800 rounded-3xl p-8 max-w-md w-full shadow-2xl relative"
		>
			<h3
				class="text-2xl font-bold text-white mb-2"
				style="font-family: 'Bebas Neue', sans-serif;"
			>
				Confirm Delete
			</h3>
			<p class="text-neutral-400 mb-6">
				Are you sure you want to delete <span
					id="delete-target-title"
					class="text-white font-bold"></span>? This action cannot be
				undone.
			</p>
			<div class="flex justify-end gap-4">
				<button
					id="cancel-delete"
					class="px-6 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-xl transition-colors font-medium"
				>
					Cancel
				</button>
				<button
					id="confirm-delete"
					class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl transition-colors font-medium shadow-lg hover:shadow-red-600/20"
				>
					Delete
				</button>
			</div>
		</div>
	</dialog>
</AdminLayout>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const deleteButtons = document.querySelectorAll(".delete-btn");
		const modal = document.getElementById(
			"delete-modal",
		) as HTMLDialogElement;
		const cancelBtn = document.getElementById("cancel-delete");
		const confirmBtn = document.getElementById("confirm-delete");
		const targetTitleSpan = document.getElementById("delete-target-title");
		let deleteId: string | null = null;

		deleteButtons.forEach((btn) => {
			btn.addEventListener("click", () => {
				deleteId = btn.getAttribute("data-id");
				const title = btn.getAttribute("data-title");
				if (targetTitleSpan) targetTitleSpan.textContent = `"${title}"`;
				modal?.classList.remove("hidden");
				modal?.showModal();
			});
		});

		cancelBtn?.addEventListener("click", () => {
			modal?.close();
			modal?.classList.add("hidden");
			deleteId = null;
		});

		confirmBtn?.addEventListener("click", async () => {
			if (!deleteId) return;

			// Add loading state
			confirmBtn.textContent = "Deleting...";
			confirmBtn.setAttribute("disabled", "true");

			try {
				const response = await fetch(`/api/admin/blogs/${deleteId}`, {
					method: "DELETE",
				});

				if (response.ok) {
					window.location.reload();
				} else {
					alert("Failed to delete blog post");
					confirmBtn.textContent = "Delete";
					confirmBtn.removeAttribute("disabled");
				}
			} catch (error) {
				console.error("Error:", error);
				alert("An error occurred");
				confirmBtn.textContent = "Delete";
				confirmBtn.removeAttribute("disabled");
			}
		});

		// Close on backdrop click
		modal?.addEventListener("click", (e) => {
			const dialogDimensions = modal.getBoundingClientRect();
			if (
				e.clientX < dialogDimensions.left ||
				e.clientX > dialogDimensions.right ||
				e.clientY < dialogDimensions.top ||
				e.clientY > dialogDimensions.bottom
			) {
				modal.close();
				modal.classList.add("hidden");
			}
		});
	});
</script>
