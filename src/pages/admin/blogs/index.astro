---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { getBlogs } from "../../../lib/services/blogs";
import { getAllCategories } from "../../../lib/services/categories";

const page = Number(Astro.url.searchParams.get("page")) || 1;
const limit = 12;
const status = Astro.url.searchParams.get("status") || "all";
const search = Astro.url.searchParams.get("search") || "";
const view = Astro.url.searchParams.get("view") || "table";
const categoryId = Astro.url.searchParams.get("category") || "all";

// Fetch categories for the filter dropdown
const categories: any[] = await getAllCategories();

const { blogs, total, totalPages } = await getBlogs({
	page,
	limit,
	status: status === "all" ? undefined : status,
	search,
	categoryId: categoryId === "all" ? undefined : parseInt(categoryId),
});

// Generate page numbers with ellipsis for industry-standard pagination
function getPageNumbers(current: number, total: number): (number | string)[] {
	const pages: (number | string)[] = [];

	if (total <= 7) {
		// Show all pages if 7 or fewer
		for (let i = 1; i <= total; i++) {
			pages.push(i);
		}
	} else {
		// Always show first page
		pages.push(1);

		if (current > 3) {
			pages.push('...');
		}

		// Show pages around current
		const start = Math.max(2, current - 1);
		const end = Math.min(total - 1, current + 1);

		for (let i = start; i <= end; i++) {
			pages.push(i);
		}

		if (current < total - 2) {
			pages.push('...');
		}

		// Always show last page
		pages.push(total);
	}

	return pages;
}

const pages = getPageNumbers(page, totalPages);
---

<AdminLayout title="Manage Blogs">
	<div class="space-y-6">
		<!-- Header -->
		<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
			<div>
				<h1 class="text-2xl font-semibold text-gray-900">All Posts</h1>
				<p class="text-gray-500 text-sm mt-1">Manage, edit, and publish your content</p>
			</div>
			<a
				href="/admin/blogs/create"
				class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
			>
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
				</svg>
				<span>Create New</span>
			</a>
		</div>

		<!-- Filters & Controls -->
		<div class="bg-white border border-gray-200 rounded-lg p-4 flex flex-col lg:flex-row gap-4 items-center justify-between">
			<!-- Search & Filter -->
			<form class="flex flex-1 w-full lg:w-auto flex-col sm:flex-row gap-3 items-center" method="get">
				<input type="hidden" name="view" value={view} />

				<!-- Search Input Group -->
				<div class="flex w-full max-w-md gap-2">
					<div class="relative flex-1">
						<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
							<svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
							</svg>
						</div>
						<input
							type="text"
							name="search"
							value={search}
							placeholder="Search posts by title..."
							class="block w-full pl-10 pr-3 h-10 bg-gray-50 border border-gray-200 rounded-lg text-gray-900 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
						/>
					</div>
					<button
						type="submit"
						class="px-4 h-10 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors border border-gray-200"
					>
						Search
					</button>
				</div>

				<!-- Status Filter -->
				<div class="relative w-full sm:w-[140px]">
					<select
						name="status"
						onchange="this.form.submit()"
						class="block w-full pl-3 pr-10 h-10 bg-gray-50 border border-gray-200 rounded-lg text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none cursor-pointer"
					>
						<option value="all" selected={status === "all"}>All Status</option>
						<option value="published" selected={status === "published"}>Published</option>
						<option value="draft" selected={status === "draft"}>Draft</option>
						<option value="archived" selected={status === "archived"}>Archived</option>
					</select>
					<div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
						<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</div>
				</div>

				<!-- Category Filter -->
				<div class="relative w-full sm:w-[160px]">
					<select
						name="category"
						onchange="this.form.submit()"
						class="block w-full pl-3 pr-10 h-10 bg-gray-50 border border-gray-200 rounded-lg text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none cursor-pointer"
					>
						<option value="all" selected={categoryId === "all"}>All Categories</option>
						{categories.map((cat: any) => (
							<option value={cat.id} selected={categoryId === cat.id.toString()}>
								{cat.name}
							</option>
						))}
					</select>
					<div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
						<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
						</svg>
					</div>
				</div>
			</form>

			<!-- View Toggle -->
			<div class="flex items-center h-10 bg-gray-100 p-1 rounded-lg border border-gray-200">
				<a
					href={`?page=${page}&status=${status}&search=${search}&category=${categoryId}&view=table`}
					class={`h-8 px-3 flex items-center justify-center rounded-md transition-all ${view === "table" ? "bg-white text-gray-900 shadow-sm" : "text-gray-500 hover:text-gray-700"}`}
					title="Table View"
				>
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
					</svg>
				</a>
				<a
					href={`?page=${page}&status=${status}&search=${search}&category=${categoryId}&view=card`}
					class={`h-8 px-3 flex items-center justify-center rounded-md transition-all ${view === "card" ? "bg-white text-gray-900 shadow-sm" : "text-gray-500 hover:text-gray-700"}`}
					title="Card View"
				>
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
					</svg>
				</a>
			</div>
		</div>

		<!-- Content -->
		{
			blogs.length === 0 ? (
				<div class="bg-white border border-gray-200 rounded-lg p-12 text-center">
					<div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-4">
						<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
							/>
							</svg>
						</div>
						<h3 class="text-lg font-semibold text-gray-900 mb-2">No posts found</h3>
						<p class="text-gray-500 mb-4">Try adjusting your search or filters, or create a new post.</p>
						<a
							href="/admin/blogs/create"
							class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
						>
							Create Post
						</a>
					</div>
			) : view === "table" ? (
				// Table View
				<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
					<div class="overflow-x-auto">
						<table class="w-full text-left border-collapse">
							<thead>
								<tr class="bg-gray-50 border-b border-gray-200">
									<th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Post</th>
									<th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
									<th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
									<th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
									<th class="px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Actions</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-gray-100">
								{blogs.map((blog) => (
									<tr class="hover:bg-gray-50 transition-colors">
										<td class="px-4 py-3">
											<div class="flex items-center gap-3">
												{blog.image_blog_featuredImageIdToimage ? (
													<img
														src={blog.image_blog_featuredImageIdToimage.url}
														alt={blog.title}
														class="w-10 h-10 rounded-lg object-cover"
													/>
												) : (
													<div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">
														<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path
																stroke-linecap="round"
																stroke-linejoin="round"
																stroke-width="1.5"
																d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
															/>
														</svg>
													</div>
												)}
												<div class="min-w-0">
													<p class="text-sm font-medium text-gray-900 truncate max-w-[200px]">{blog.title}</p>
													<p class="text-xs text-gray-500 truncate max-w-[200px]">
														{blog.excerpt || "No description..."}
													</p>
												</div>
											</div>
										</td>
										<td class="px-4 py-3">
											<div class="flex items-center gap-2">
												{blog.user?.avatar ? (
													<img
														src={blog.user.avatar}
														alt={blog.user.username || "User"}
														class="w-6 h-6 rounded-full object-cover"
													/>
												) : (
													<div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs text-blue-600 font-medium">
														{(blog.user?.username || "U").charAt(0).toUpperCase()}
													</div>
												)}
												<span class="text-sm text-gray-700">{blog.user?.username || "Unknown"}</span>
											</div>
										</td>
										<td class="px-4 py-3">
											<span
												class={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs font-medium ${
													blog.status === "PUBLISHED"
														? "bg-green-100 text-green-700"
														: blog.status === "DRAFT"
															? "bg-gray-100 text-gray-700"
															: "bg-orange-100 text-orange-700"
												}`}
											>
												<span
													class={`w-1.5 h-1.5 rounded-full ${
														blog.status === "PUBLISHED"
															? "bg-green-500"
															: blog.status === "DRAFT"
																? "bg-gray-500"
																: "bg-orange-500"
													}`}
												/>
												{blog.status}
											</span>
										</td>
										<td class="px-4 py-3">
											<div class="text-sm text-gray-700">
												{new Date(blog.createdAt).toLocaleDateString(undefined, {
													month: "short",
													day: "numeric",
													year: "numeric",
												})}
											</div>
											<div class="text-xs text-gray-500">
												{new Date(blog.createdAt).toLocaleTimeString(undefined, {
													hour: "2-digit",
													minute: "2-digit",
												})}
											</div>
										</td>
										<td class="px-4 py-3 text-right">
											<div class="flex items-center justify-end gap-1">
												<a
													href={`/admin/blogs/edit/${blog.id}`}
													class="p-2 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
													title="Edit Post"
												>
													<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path
															stroke-linecap="round"
															stroke-linejoin="round"
															stroke-width="2"
																d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
															/>
													</svg>
												</a>
												<button
													type="button"
													data-id={blog.id}
													data-title={blog.title}
													class="delete-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
													title="Delete Post"
												>
													<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path
															stroke-linecap="round"
															stroke-linejoin="round"
															stroke-width="2"
																d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
															/>
													</svg>
												</button>
											</div>
										</td>
									</tr>
								))}
							</tbody>
						</table>
					</div>

					<!-- Table Footer with Pagination Info -->
					<div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-t border-gray-200">
						<p class="text-sm text-gray-500">
							Showing <span class="font-medium text-gray-900">{(page - 1) * limit + 1}</span> to{" "}
							<span class="font-medium text-gray-900">{Math.min(page * limit, total)}</span> of{" "}
							<span class="font-medium text-gray-900">{total}</span> results
						</p>
						{totalPages > 1 && (
							<div class="flex items-center gap-2">
								{page > 1 && (
									<a
										href={`?page=${page - 1}&status=${status}&search=${search}&category=${categoryId}&view=${view}`}
										class="px-3 py-1.5 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 rounded-lg transition-colors text-sm font-medium"
									>
										Previous
									</a>
								)}
								<div class="flex gap-1">
									{pages.map((p) => {
										if (p === '...') {
											return (
												<span class="px-3 py-1.5 text-sm text-gray-400 cursor-default">...</span>
											);
										}
										return (
											<a
												href={`?page=${p}&status=${status}&search=${search}&category=${categoryId}&view=${view}`}
												class={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
													p === page ? "bg-blue-600 text-white" : "bg-white border border-gray-200 text-gray-700 hover:bg-gray-50"
												}`}
											>
												{p}
											</a>
										);
									})}
								</div>
								{page < totalPages && (
									<a
										href={`?page=${page + 1}&status=${status}&search=${search}&category=${categoryId}&view=${view}`}
										class="px-3 py-1.5 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 rounded-lg transition-colors text-sm font-medium"
									>
										Next
									</a>
								)}
							</div>
						)}
					</div>
				</div>
			) : (
				// Card View
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
					{blogs.map((blog) => (
						<div class="bg-white rounded-lg border border-gray-200 overflow-hidden hover:border-gray-300 transition-colors">
							<div class="relative h-40 bg-gray-100 overflow-hidden">
								{blog.image_blog_featuredImageIdToimage ? (
									<img
										src={blog.image_blog_featuredImageIdToimage.url}
										alt={blog.title}
										class="w-full h-full object-cover"
									/>
								) : (
									<div class="w-full h-full flex items-center justify-center text-gray-300">
										<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="1.5"
												d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
											/>
										</svg>
									</div>
								)}
								<div class="absolute top-2 right-2">
									<span
										class={`px-2 py-1 rounded text-xs font-medium ${
											blog.status === "PUBLISHED"
												? "bg-green-500 text-white"
												: blog.status === "DRAFT"
													? "bg-gray-500 text-white"
													: "bg-orange-500 text-white"
										}`}
									>
										{blog.status}
									</span>
								</div>
							</div>
							<div class="p-4">
								<h3 class="text-base font-semibold text-gray-900 mb-1 line-clamp-1">{blog.title}</h3>
								<p class="text-sm text-gray-500 line-clamp-2 mb-3">{blog.excerpt || "No excerpt available."}</p>
								<div class="flex items-center justify-between pt-3 border-t border-gray-100">
									<span class="text-xs text-gray-500">
										{new Date(blog.createdAt).toLocaleDateString()}
									</span>
									<div class="flex gap-1">
										<a
											href={`/admin/blogs/edit/${blog.id}`}
											class="p-1.5 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
														d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
													/>
											</svg>
										</a>
										<button
											type="button"
											data-id={blog.id}
											data-title={blog.title}
											class="delete-btn p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
														d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
													/>
											</svg>
										</button>
									</div>
								</div>
							</div>
						</div>
					))}
				</div>
			)
		}

		<!-- Pagination -->
		{
			totalPages > 1 && (
				<div class="flex items-center justify-between pt-4 border-t border-gray-200">
					<p class="text-sm text-gray-500">
						Showing <span class="font-medium text-gray-900">{(page - 1) * limit + 1}</span> to{" "}
						<span class="font-medium text-gray-900">{Math.min(page * limit, total)}</span> of{" "}
						<span class="font-medium text-gray-900">{total}</span> results
					</p>
					<div class="flex gap-2">
						{page > 1 && (
							<a
								href={`?page=${page - 1}&status=${status}&search=${search}&category=${categoryId}&view=${view}`}
								class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors text-sm font-medium"
							>
								Previous
							</a>
						)}
					<div class="flex gap-1">
						{pages.map((p) => {
							if (p === '...') {
								return (
									<span class="px-3 py-1.5 text-sm text-gray-400 cursor-default">...</span>
								);
							}
							return (
								<a
									href={`?page=${p}&status=${status}&search=${search}&category=${categoryId}&view=${view}`}
									class={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
										p === page ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-700 hover:bg-gray-200"
									}`}
								>
									{p}
								</a>
							);
						})}
					</div>
						{page < totalPages && (
							<a
								href={`?page=${page + 1}&status=${status}&search=${search}&category=${categoryId}&view=${view}`}
								class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors text-sm font-medium"
							>
								Next
							</a>
						)}
					</div>
				</div>
			)
		}
	</div>

	<!-- Delete Confirmation Modal -->
	<dialog
		id="delete-modal"
		class="bg-transparent p-0 w-full h-full max-w-none max-h-none backdrop:bg-black/50 z-50 open:flex items-center justify-center fixed inset-0 hidden"
	>
		<div class="bg-white border border-gray-200 rounded-lg p-6 max-w-sm w-full shadow-lg relative">
			<h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Delete</h3>
			<p class="text-gray-600 text-sm mb-4">
				Are you sure you want to delete <span id="delete-target-title" class="font-medium text-gray-900"></span>? This action cannot be undone.
			</p>
			<div class="flex justify-end gap-3">
				<button
					id="cancel-delete"
					class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors text-sm font-medium"
				>
					Cancel
				</button>
				<button
					id="confirm-delete"
					class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors text-sm font-medium"
				>
					Delete
				</button>
			</div>
		</div>
	</dialog>
</AdminLayout>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const deleteButtons = document.querySelectorAll(".delete-btn");
		const modal = document.getElementById("delete-modal") as HTMLDialogElement;
		const cancelBtn = document.getElementById("cancel-delete");
		const confirmBtn = document.getElementById("confirm-delete");
		const targetTitleSpan = document.getElementById("delete-target-title");
		let deleteId: string | null = null;

		deleteButtons.forEach((btn) => {
			btn.addEventListener("click", () => {
				deleteId = btn.getAttribute("data-id");
				const title = btn.getAttribute("data-title");
				if (targetTitleSpan) targetTitleSpan.textContent = `"${title}"`;
				modal?.classList.remove("hidden");
				modal?.showModal();
			});
		});

		cancelBtn?.addEventListener("click", () => {
			modal?.close();
			modal?.classList.add("hidden");
			deleteId = null;
		});

		confirmBtn?.addEventListener("click", async () => {
			if (!deleteId) return;

			confirmBtn.textContent = "Deleting...";
			confirmBtn.setAttribute("disabled", "true");

			try {
				const response = await fetch(`/api/admin/blogs/${deleteId}`, {
					method: "DELETE",
				});

				if (response.ok) {
					window.location.reload();
				} else {
					alert("Failed to delete blog post");
					confirmBtn.textContent = "Delete";
					confirmBtn.removeAttribute("disabled");
				}
			} catch (error) {
				console.error("Error:", error);
				alert("An error occurred");
				confirmBtn.textContent = "Delete";
				confirmBtn.removeAttribute("disabled");
			}
		});

		modal?.addEventListener("click", (e) => {
			const dialogDimensions = modal.getBoundingClientRect();
			if (
				e.clientX < dialogDimensions.left ||
				e.clientX > dialogDimensions.right ||
				e.clientY < dialogDimensions.top ||
				e.clientY > dialogDimensions.bottom
			) {
				modal.close();
				modal.classList.add("hidden");
			}
		});
	});
</script>
